<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>mission docs - case files</title>
    <link id="favicon" rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* === RESET === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body,
        html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #2a2418;
            font-family: 'Courier Prime', monospace;
            cursor: default;
            user-select: none;
            -webkit-user-select: none;
            overscroll-behavior: none;
            touch-action: none;
        }

        /* === FILM GRAIN OVERLAY === */
        #grain-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml,%3Csvg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg"%3E%3Cfilter id="noiseFilter"%3E%3CfeTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="100%25" height="100%25" filter="url(%23noiseFilter)"/%3E%3C/svg%3E');
            opacity: 0.08;
            pointer-events: none;
            z-index: 100;
            mix-blend-mode: overlay;
        }

        /* === DESK LAMP LIGHTING === */
        #desk-light {
            position: absolute;
            top: -10%;
            left: 20%;
            width: 60%;
            height: 70%;
            background: radial-gradient(ellipse 50% 40% at 30% 30%,
                    rgba(255, 243, 210, 0.3) 0%,
                    rgba(255, 243, 210, 0.1) 40%,
                    transparent 70%);
            pointer-events: none;
            z-index: 2;
            mix-blend-mode: overlay;
        }

        /* === DESK CONTAINER === */
        #desk-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background:
                radial-gradient(ellipse 60% 50% at 40% 30%,
                    rgba(244, 234, 213, 0.12) 0%,
                    transparent 50%),
                #2a2418;
            overflow: hidden;
        }

        /* === FILING AREA === */
        #filing-area {
            position: fixed;
            left: -240px;
            /* mostly off-screen */
            top: 20px;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
            transition: left 0.4s ease;
            padding: 15px;
            width: 300px;
            background: rgba(42, 36, 24, 0.95);
            border-right: 2px solid rgba(201, 169, 97, 0.3);
            overflow-y: auto;
        }

        #filing-area.visible {
            left: 0px;
        }

        .folder-stack {
            position: relative;
            width: 100%;
            background: linear-gradient(135deg, rgba(201, 169, 97, 0.3) 0%, rgba(139, 115, 85, 0.2) 100%);
            border: 1px solid rgba(201, 169, 97, 0.5);
            border-radius: 4px;
            padding: 0;
            transition: all 0.2s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .folder-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #e8dfc4;
        }

        .folder-stack:hover {
            background: linear-gradient(135deg, rgba(201, 169, 97, 0.4) 0%, rgba(139, 115, 85, 0.3) 100%);
        }

        .file-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .folder-stack.expanded .file-list {
            max-height: 600px;
        }

        .file-list-item {
            padding: 10px 15px;
            border-top: 1px solid rgba(201, 169, 97, 0.2);
            cursor: grab;
            transition: background 0.2s ease;
            font-size: 11px;
            color: #e8dfc4;
        }

        .file-list-item:hover {
            background: rgba(244, 234, 213, 0.1);
        }

        .file-list-item:active {
            cursor: grabbing;
        }

        .file-item-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .file-item-year {
            font-size: 9px;
            opacity: 0.6;
        }

        .folder-stack[data-category="saas"] {
            background: linear-gradient(135deg, rgba(58, 124, 165, 0.3) 0%, rgba(48, 104, 145, 0.2) 100%);
            border-color: rgba(58, 124, 165, 0.5);
            color: #3a7ca5;
        }

        .folder-stack[data-category="ecommerce"] {
            background: linear-gradient(135deg, rgba(201, 85, 77, 0.3) 0%, rgba(181, 65, 57, 0.2) 100%);
            border-color: rgba(201, 85, 77, 0.5);
            color: #c9554d;
        }

        .folder-stack[data-category="design"] {
            background: linear-gradient(135deg, rgba(107, 142, 35, 0.3) 0%, rgba(87, 122, 25, 0.2) 100%);
            border-color: rgba(107, 142, 35, 0.5);
            color: #6b8e23;
        }

        .folder-stack.drag-over {
            transform: scale(1.08);
            box-shadow:
                0 8px 20px rgba(244, 234, 213, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .file-count {
            font-size: 9px;
            opacity: 0.6;
            font-weight: 400;
            letter-spacing: 1px;
        }

        /* === DOCUMENTS AREA === */
        #documents-area {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .document {
            position: absolute;
            width: 280px;
            height: 200px;
            background: #e8dfc4;
            border-radius: 2px;
            box-shadow:
                0 8px 16px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            cursor: grab;
            transition: box-shadow 0.3s ease;
            will-change: transform;
            padding: 20px;
        }

        .document:active {
            cursor: grabbing;
        }

        .document.folder-style {
            background: linear-gradient(to bottom, #e8dfc4 0%, #d4c9a8 100%);
            border-top: 30px solid rgba(201, 169, 97, 0.8);
        }

        .document.photo-style {
            background: #f4f4f4;
            border: 12px solid #f4f4f4;
            box-shadow:
                0 8px 20px rgba(0, 0, 0, 0.5),
                inset 0 0 40px rgba(0, 0, 0, 0.1);
        }

        .document.photo-style .doc-content {
            background: #e8dfc4;
            width: 100%;
            height: 100%;
            padding: 15px;
        }

        .doc-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .doc-year {
            font-size: 12px;
            font-weight: 400;
            color: #666;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .category-tag {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            transform: rotate(3deg);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #fff;
        }

        .category-tag.saas {
            background: rgba(58, 124, 165, 0.9);
        }

        .category-tag.ecommerce {
            background: rgba(201, 85, 77, 0.9);
        }

        .category-tag.design {
            background: rgba(107, 142, 35, 0.9);
        }

        /* === UI OVERLAY === */
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        #filter-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #e8dfc4;
            padding: 10px 20px;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
        }

        #back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: all;
        }

        #back-link a {
            color: #e8dfc4;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 4px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        #back-link a:hover {
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
        }

        #cleanup-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(107, 142, 35, 0.9);
            color: #fff;
            border: none;
            padding: 12px 24px;
            font-family: 'Courier Prime', monospace;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            border-radius: 4px;
            cursor: pointer;
            pointer-events: all;
            transition: all 0.3s ease;
            letter-spacing: 1px;
        }

        #cleanup-btn:hover {
            background: rgba(107, 142, 35, 1);
            transform: scale(1.05);
        }

        #cleanup-btn:active {
            transform: scale(0.95);
        }

        /* === SPILLED IMAGES === */
        .spilled-image {
            position: absolute;
            width: 180px;
            height: 140px;
            background: #fff;
            border: 8px solid #f4f4f4;
            box-shadow:
                0 6px 14px rgba(0, 0, 0, 0.4),
                inset 0 0 30px rgba(0, 0, 0, 0.1);
            cursor: grab;
            will-change: transform;
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
            font-weight: 700;
        }

        .spilled-image:active {
            cursor: grabbing;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .document {
                width: 220px;
                height: 160px;
                padding: 15px;
            }

            .document.photo-style {
                border: 8px solid #f4f4f4;
            }

            .doc-title {
                font-size: 14px;
            }

            /* mobile: show folders at bottom, always visible */
            #filing-area {
                left: 50% !important;
                transform: translateX(-50%) !important;
                top: auto !important;
                bottom: 5%;
                flex-direction: row;
                width: auto;
                gap: 15px;
            }

            #filing-area.visible {
                left: 50% !important;
            }

            .folder-stack {
                width: 100px;
                height: 120px;
                font-size: 10px;
                padding: 10px;
            }

            #filter-hint {
                font-size: 10px;
                padding: 8px 12px;
                bottom: 140px;
                right: 10px;
            }

            #back-link {
                top: 10px;
                left: 10px;
            }

            #back-link a {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>

<body>
    <!-- film grain overlay -->
    <div id="grain-overlay"></div>

    <!-- desk lamp light cone -->
    <div id="desk-light"></div>

    <!-- desk surface -->
    <div id="desk-container">
        <!-- filing system (drop zones) -->
        <div id="filing-area">
            <div class="folder-stack" data-category="saas">
                <div class="folder-header">
                    <span>SAAS</span>
                    <span class="file-count">0</span>
                </div>
                <div class="file-list"></div>
            </div>
            <div class="folder-stack" data-category="ecommerce">
                <div class="folder-header">
                    <span>ECOMMERCE</span>
                    <span class="file-count">0</span>
                </div>
                <div class="file-list"></div>
            </div>
            <div class="folder-stack" data-category="design">
                <div class="folder-header">
                    <span>DESIGN</span>
                    <span class="file-count">0</span>
                </div>
                <div class="file-list"></div>
            </div>
        </div>

        <!-- draggable documents container -->
        <div id="documents-area"></div>
    </div>

    <!-- ui overlay -->
    <div id="ui-overlay">
        <div id="filter-hint">click to spill • double-click to open • drag anywhere</div>
        <div id="back-link"><a href="/">← back</a></div>
        <button id="cleanup-btn">clean up desk</button>
    </div>

    <!-- gsap cdn -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/Draggable.min.js"></script>

    <script>
        // register gsap plugin
        gsap.registerPlugin(Draggable);

        // work data (14 items from main index.html)
        // placeholder images: using picsum.photos for now, replace with real images later
        const WORK_ITEMS = [
            {
                title: 'Reveo', url: 'https://reveo.com', category: 'saas', type: 'folder', year: '2024',
                images: ['https://picsum.photos/seed/reveo1/400/300', 'https://picsum.photos/seed/reveo2/400/300', 'https://picsum.photos/seed/reveo3/400/300']
            },
            {
                title: 'Snowie', url: 'https://zakknowlton.com/snowie', category: 'ecommerce', type: 'folder', year: '2023',
                images: ['https://picsum.photos/seed/snowie1/400/300', 'https://picsum.photos/seed/snowie2/400/300', 'https://picsum.photos/seed/snowie3/400/300', 'https://picsum.photos/seed/snowie4/400/300']
            },
            {
                title: 'Green Philosophy Co', url: 'https://zakknowlton.com/green-philosophy', category: 'ecommerce', type: 'folder', year: '2023',
                images: ['https://picsum.photos/seed/green1/400/300', 'https://picsum.photos/seed/green2/400/300', 'https://picsum.photos/seed/green3/400/300']
            },
            {
                title: 'Raveyard Sounds', url: 'https://zakknowlton.com/raveyard-sounds', category: 'ecommerce', type: 'folder', year: '2022',
                images: ['https://picsum.photos/seed/raveyard1/400/300', 'https://picsum.photos/seed/raveyard2/400/300', 'https://picsum.photos/seed/raveyard3/400/300', 'https://picsum.photos/seed/raveyard4/400/300']
            },
            {
                title: 'Shockwav Sound Co', url: 'https://zakknowlton.com/shockwav', category: 'ecommerce', type: 'folder', year: '2022',
                images: ['https://picsum.photos/seed/shockwav1/400/300', 'https://picsum.photos/seed/shockwav2/400/300', 'https://picsum.photos/seed/shockwav3/400/300']
            },
            {
                title: 'gothparade', url: 'https://zakknowlton.com/gothparade', category: 'design', type: 'photo', year: '2024',
                images: ['https://picsum.photos/seed/goth1/400/300', 'https://picsum.photos/seed/goth2/400/300', 'https://picsum.photos/seed/goth3/400/300', 'https://picsum.photos/seed/goth4/400/300']
            },
            {
                title: 'Rave Water', url: 'https://zakknowlton.com/rave-water', category: 'design', type: 'photo', year: '2023',
                images: ['https://picsum.photos/seed/ravewater1/400/300', 'https://picsum.photos/seed/ravewater2/400/300', 'https://picsum.photos/seed/ravewater3/400/300']
            },
            {
                title: 'Glass Heart', url: 'https://zakknowlton.com/glass-heart', category: 'design', type: 'photo', year: '2023',
                images: ['https://picsum.photos/seed/glass1/400/300', 'https://picsum.photos/seed/glass2/400/300', 'https://picsum.photos/seed/glass3/400/300', 'https://picsum.photos/seed/glass4/400/300']
            },
            {
                title: 'Beat Secrets', url: 'https://zakknowlton.com/beat-secrets', category: 'design', type: 'photo', year: '2022',
                images: ['https://picsum.photos/seed/beat1/400/300', 'https://picsum.photos/seed/beat2/400/300', 'https://picsum.photos/seed/beat3/400/300']
            },
            {
                title: 'us2', url: 'https://zakknowlton.com/us2', category: 'design', type: 'photo', year: '2022',
                images: ['https://picsum.photos/seed/us2a/400/300', 'https://picsum.photos/seed/us2b/400/300', 'https://picsum.photos/seed/us2c/400/300', 'https://picsum.photos/seed/us2d/400/300']
            },
            {
                title: 'Polar Culture', url: 'https://zakknowlton.com/polar-culture', category: 'design', type: 'photo', year: '2021',
                images: ['https://picsum.photos/seed/polar1/400/300', 'https://picsum.photos/seed/polar2/400/300', 'https://picsum.photos/seed/polar3/400/300']
            },
            {
                title: 'Lil Dusty G', url: 'https://zakknowlton.com/lil-dusty', category: 'design', type: 'photo', year: '2021',
                images: ['https://picsum.photos/seed/dusty1/400/300', 'https://picsum.photos/seed/dusty2/400/300', 'https://picsum.photos/seed/dusty3/400/300', 'https://picsum.photos/seed/dusty4/400/300']
            },
            {
                title: 'School of Bass', url: 'https://zakknowlton.com/school-of-bass', category: 'design', type: 'photo', year: '2020',
                images: ['https://picsum.photos/seed/bass1/400/300', 'https://picsum.photos/seed/bass2/400/300', 'https://picsum.photos/seed/bass3/400/300']
            },
            {
                title: 'Crywolf', url: 'https://zakknowlton.com/crywolf', category: 'design', type: 'photo', year: '2020',
                images: ['https://picsum.photos/seed/crywolf1/400/300', 'https://picsum.photos/seed/crywolf2/400/300', 'https://picsum.photos/seed/crywolf3/400/300', 'https://picsum.photos/seed/crywolf4/400/300']
            }
        ];

        // state management
        const state = {
            draggables: [],
            currentZIndex: 10,
            selectedDoc: null,
            isMobile: window.innerWidth <= 768,
            spilledFolders: new Set(), // track which folders have spilled
            spilledImages: {}, // map folder index to array of spilled image elements
            heldStack: [], // items collected via shake
            shakeContext: {
                history: [],
                lastX: 0,
                direction: 0, // 1 for right, -1 for left
                reversals: 0,
                lastReversalTime: 0
            },
            isHoveringParent: false, // tracks if currently hovering valid parent folder
            hoveredParentId: null // tracks which folder is being hovered
        };

        // initialization
        function init() {
            setupFilingAreaInteractions();
            addKeyboardShortcuts();

            // cleanup button
            document.getElementById('cleanup-btn').addEventListener('click', cleanupAllImages);

            // click on desk background to cleanup
            document.getElementById('desk-container').addEventListener('click', (e) => {
                // only if clicking directly on the desk or background elements
                if (e.target.id === 'desk-container' ||
                    e.target.id === 'desk-light' ||
                    e.target.id === 'grain-overlay' ||
                    e.target.id === 'documents-area') {
                    cleanupAllImages();
                }
            });
        }

        // filing area mouse interactions
        function setupFilingAreaInteractions() {
            const filingArea = document.getElementById('filing-area');
            const folders = document.querySelectorAll('.folder-stack');

            // mouse proximity detection - show filing area when mouse near left edge
            document.addEventListener('mousemove', (e) => {
                if (state.isMobile) return;

                const distanceFromLeft = e.clientX;

                // show when mouse within 80px of left edge (much tighter to avoid stealing clicks)
                if (distanceFromLeft < 80) {
                    filingArea.classList.add('visible');
                } else if (distanceFromLeft > 350) {
                    filingArea.classList.remove('visible');
                }
            });

            // click folder header to toggle expand/collapse
            folders.forEach(folder => {
                const header = folder.querySelector('.folder-header');
                header.addEventListener('click', () => {
                    folder.classList.toggle('expanded');
                });
            });

            // populate file lists
            populateFileLists();
        }

        // populate file lists in buckets
        function populateFileLists() {
            WORK_ITEMS.forEach(item => {
                const folder = document.querySelector(`.folder-stack[data-category="${item.category}"]`);
                const fileList = folder.querySelector('.file-list');

                const listItem = document.createElement('div');
                listItem.className = 'file-list-item';
                listItem.dataset.index = WORK_ITEMS.indexOf(item);
                listItem.dataset.category = item.category;
                listItem.dataset.url = item.url;
                listItem.dataset.images = JSON.stringify(item.images);
                listItem.dataset.title = item.title;
                listItem.dataset.year = item.year;

                listItem.innerHTML = `
                    <div class="file-item-title">${item.title}</div>
                    <div class="file-item-year">${item.year}</div>
                `;

                // make list item draggable - creates document on drag
                listItem.addEventListener('mousedown', (e) => {
                    createDocumentFromListItem(listItem, e);
                });

                fileList.appendChild(listItem);
            });

            updateFileCounts();
        }

        // create draggable document from list item
        function createDocumentFromListItem(listItem, e) {
            const container = document.getElementById('documents-area');
            const containerRect = container.getBoundingClientRect();

            const doc = document.createElement('div');
            const item = WORK_ITEMS[listItem.dataset.index];
            doc.className = `document ${item.type}-style`;
            doc.dataset.category = listItem.dataset.category;
            doc.dataset.url = listItem.dataset.url;
            doc.dataset.index = listItem.dataset.index;
            doc.dataset.images = listItem.dataset.images;

            // position at mouse
            const mouseX = e.clientX - containerRect.left;
            const mouseY = e.clientY - containerRect.top;

            gsap.set(doc, {
                x: mouseX - 140,
                y: mouseY - 100,
                rotation: 0,
                zIndex: state.currentZIndex++
            });

            doc.innerHTML = `
                <div class="doc-content">
                    <h3 class="doc-title">${listItem.dataset.title}</h3>
                    <div class="doc-year">${listItem.dataset.year}</div>
                    <div class="category-tag ${listItem.dataset.category}">${listItem.dataset.category.toUpperCase()}</div>
                </div>
            `;

            container.appendChild(doc);

            // setup draggable immediately
            const draggable = Draggable.create(doc, {
                type: 'x,y',
                bounds: '#desk-container',
                inertia: state.isMobile ? false : true,
                edgeResistance: 0.8,

                onPress: function () {
                    state.currentZIndex++;
                    gsap.to(this.target, {
                        zIndex: state.currentZIndex,
                        scale: 1.05,
                        boxShadow: '0 20px 40px rgba(0,0,0,0.7)',
                        duration: 0.2
                    });
                },

                onDrag: function () {
                    checkDropZoneOverlap(this.target);
                },

                onDragEnd: function () {
                    gsap.to(this.target, {
                        scale: 1,
                        boxShadow: '0 8px 16px rgba(0,0,0,0.4)',
                        duration: 0.3
                    });
                    handleDropZoneSnap(this.target);
                },

                onClick: function () {
                    let clickCount = this.clickCount || 0;
                    clickCount++;
                    this.clickCount = clickCount;

                    if (clickCount === 1) {
                        setTimeout(() => {
                            if (this.clickCount === 1) {
                                spillImages(this.target);
                            }
                            this.clickCount = 0;
                        }, 300);
                    } else if (clickCount === 2) {
                        openDocument(this.target);
                        this.clickCount = 0;
                    }
                }
            })[0];

            // trigger drag immediately
            draggable.startDrag(e);

            // remove from list
            listItem.remove();
            updateFileCounts();
        }

        // generate document divs dynamically
        function generateDocuments() {
            const container = document.getElementById('documents-area');

            // get folder positions
            const folders = {
                saas: document.querySelector('.folder-stack[data-category="saas"]'),
                ecommerce: document.querySelector('.folder-stack[data-category="ecommerce"]'),
                design: document.querySelector('.folder-stack[data-category="design"]')
            };

            // track count per category
            const counts = { saas: 0, ecommerce: 0, design: 0 };

            WORK_ITEMS.forEach((item, index) => {
                const doc = document.createElement('div');
                doc.className = `document ${item.type}-style`;
                doc.dataset.category = item.category;
                doc.dataset.url = item.url;
                doc.dataset.index = index;

                // store images data
                doc.dataset.images = JSON.stringify(item.images);

                // position in category bucket (stacked)
                const folder = folders[item.category];
                const folderRect = folder.getBoundingClientRect();
                const containerRect = document.getElementById('desk-container').getBoundingClientRect();

                const stackOffset = counts[item.category] * 2;
                const baseX = folderRect.left - containerRect.left + 20;
                const baseY = folderRect.top - containerRect.top + 40;

                gsap.set(doc, {
                    x: baseX + stackOffset,
                    y: baseY + stackOffset,
                    rotation: 0,
                    scale: 0.6, // smaller in bucket
                    zIndex: 10 + index
                });

                counts[item.category]++;

                // content structure
                doc.innerHTML = `
                    <div class="doc-content">
                        <h3 class="doc-title">${item.title}</h3>
                        <div class="doc-year">${item.year}</div>
                        <div class="category-tag ${item.category}">${item.category.toUpperCase()}</div>
                    </div>
                `;

                container.appendChild(doc);
            });

            // update file counts
            updateFileCounts();
        }

        // update file count displays
        function updateFileCounts() {
            const counts = { saas: 0, ecommerce: 0, design: 0 };

            document.querySelectorAll('.file-list-item').forEach(item => {
                counts[item.dataset.category]++;
            });

            Object.keys(counts).forEach(category => {
                const folder = document.querySelector(`.folder-stack[data-category="${category}"]`);
                const countSpan = folder.querySelector('.file-count');
                countSpan.textContent = counts[category];
            });
        }

        // gsap draggable setup
        function setupDraggables() {
            const docs = document.querySelectorAll('.document');

            docs.forEach(doc => {
                let clickCount = 0;
                let clickTimeout = null;

                const draggable = Draggable.create(doc, {
                    type: 'x,y',
                    bounds: '#desk-container',
                    inertia: state.isMobile ? false : true,
                    edgeResistance: 0.8,

                    onPress: function () {
                        // bring to front
                        state.currentZIndex++;
                        gsap.to(this.target, {
                            zIndex: state.currentZIndex,
                            scale: 1.05,
                            boxShadow: '0 20px 40px rgba(0,0,0,0.7)',
                            duration: 0.2
                        });
                        state.selectedDoc = this.target;

                        // Reset shake context
                        state.shakeContext.history = [];
                        state.shakeContext.lastX = this.x;
                        state.shakeContext.reversals = 0;
                        state.shakeContext.direction = 0;
                    },

                    onDrag: function () {
                        // Check for shake gesture
                        checkShake(this);

                        // Move collected stack if any
                        updateHeldStackPosition(this.target);

                        // check overlapping with specific parent folder for swell
                        checkDropZoneOverlap(this.target);
                    },

                    onDragEnd: function () {
                        // reset scale
                        gsap.to(this.target, {
                            scale: 1,
                            boxShadow: '0 8px 16px rgba(0,0,0,0.4)',
                            duration: 0.3,
                            ease: 'power2.out'
                        });

                        // Check if dropped on parent
                        const droppedOnParent = handleDropZoneSnap(this.target);

                        // Release stack (scatter or return to list)
                        releaseStack(droppedOnParent);
                    },

                    onClick: function () {
                        // handle click vs double-click
                        clickCount++;

                        if (clickCount === 1) {
                            clickTimeout = setTimeout(() => {
                                // single click = spill images
                                spillImages(this.target);
                                clickCount = 0;
                            }, 300);
                        } else if (clickCount === 2) {
                            // double click = open url
                            clearTimeout(clickTimeout);
                            openDocument(this.target);
                            clickCount = 0;
                        }
                    }
                })[0];

                state.draggables.push(draggable);
            });
        }

        // === SHAKE & STACK LOGIC ===

        function checkShake(draggable) {
            const currentX = draggable.x;
            const now = Date.now();
            const ctx = state.shakeContext;

            // Calculate delta and direction
            const delta = currentX - ctx.lastX;
            const direction = Math.sign(delta);

            // Only count significant moves
            if (Math.abs(delta) > 15) { // Increased threshold to avoid accidental triggers
                if (direction !== ctx.direction && ctx.direction !== 0) {
                    // Direction reversal detected
                    if (now - ctx.lastReversalTime < 300) { // Must be quick
                        ctx.reversals++;
                    } else {
                        ctx.reversals = 1;
                    }
                    ctx.lastReversalTime = now;
                }
                ctx.direction = direction;
            }

            ctx.lastX = currentX;

            // Trigger shake if reversals threshold met
            // Reset reversals immediately to prevent multi-trigger
            if (ctx.reversals >= 5 && state.heldStack.length === 0) {
                collectSiblings(draggable.target);
                ctx.reversals = 0;
            }
        }

        function collectSiblings(leaderDoc) {
            const category = leaderDoc.dataset.category;
            const allDocs = document.querySelectorAll('.document');

            // Find valid siblings on the desk
            const siblings = Array.from(allDocs).filter(doc =>
                doc !== leaderDoc &&
                doc.dataset.category === category &&
                !state.heldStack.some(item => item.el === doc)
            );

            if (siblings.length === 0) return;

            // Animate them to the leader
            siblings.forEach((doc, i) => {
                // Disable individual dragging for siblings
                const dragInstance = Draggable.get(doc);
                if (dragInstance) dragInstance.disable();

                // Add to stack
                state.heldStack.push({
                    el: doc,
                    offsetX: (Math.random() * 20 - 10),
                    offsetY: (Math.random() * 20 - 10) + 10
                });

                // Animate to position
                gsap.to(doc, {
                    x: gsap.getProperty(leaderDoc, "x") + (Math.random() * 20 - 10),
                    y: gsap.getProperty(leaderDoc, "y") + (Math.random() * 20 - 10) + 10,
                    rotation: gsap.getProperty(leaderDoc, "rotation") + (Math.random() * 10 - 5),
                    scale: 1,
                    zIndex: state.currentZIndex - 1 - i,
                    duration: 0.5,
                    ease: "back.out(1.2)"
                });
            });

            // Pulse the leader
            gsap.fromTo(leaderDoc,
                { scale: 1.15 },
                { scale: 1.05, duration: 0.3, ease: "elastic.out(1, 0.3)" }
            );

            // Optional: Haptic or visual cue
        }

        function updateHeldStackPosition(leaderDoc) {
            if (state.heldStack.length === 0) return;

            const leaderX = gsap.getProperty(leaderDoc, "x");
            const leaderY = gsap.getProperty(leaderDoc, "y");

            state.heldStack.forEach(item => {
                gsap.to(item.el, {
                    x: leaderX + item.offsetX,
                    y: leaderY + item.offsetY,
                    duration: 0.1, // Slight lag for natural feel
                    overwrite: "auto"
                });
            });
        }

        function releaseStack(droppedOnParent) {
            if (state.heldStack.length === 0) return;

            if (droppedOnParent) {
                // If dropped on parent, return all to list is handled by caller logic usually
                // But we can double check here
                state.heldStack.forEach(item => {
                    returnFileToList(item.el);
                });
            } else {
                // Return to desk state
                state.heldStack.forEach(item => {
                    const dragInstance = Draggable.get(item.el);
                    if (dragInstance) dragInstance.enable();

                    gsap.to(item.el, {
                        x: "+=" + (Math.random() * 60 - 30),
                        y: "+=" + (Math.random() * 60 - 30),
                        rotation: "+=" + (Math.random() * 20 - 10),
                        duration: 0.4,
                        ease: "power2.out"
                    });
                });
            }

            state.heldStack = [];
        }

        // overlap detection for drop zones (specific parent folder)
        function checkDropZoneOverlap(doc) {
            const category = doc.dataset.category;
            const targetFolder = document.querySelector(`.folder-stack[data-category="${category}"]`);

            if (!targetFolder) return;

            const docRect = doc.getBoundingClientRect();
            const folderRect = targetFolder.getBoundingClientRect();

            // Check overlap with specific folder
            const isOverlapping = !(
                docRect.right < folderRect.left ||
                docRect.left > folderRect.right ||
                docRect.bottom < folderRect.top ||
                docRect.top > folderRect.bottom
            );

            if (isOverlapping) {
                if (!state.isHoveringParent) {
                    state.isHoveringParent = true;
                    // SWELL ANIMATION
                    gsap.to(targetFolder, {
                        scale: 1.15,
                        boxShadow: '0 15px 30px rgba(201, 169, 97, 0.4)',
                        backgroundColor: 'rgba(201, 169, 97, 0.2)',
                        duration: 0.3,
                        ease: 'back.out(1.7)'
                    });
                }
            } else {
                if (state.isHoveringParent) {
                    state.isHoveringParent = false;
                    // RETURN TO NORMAL
                    gsap.to(targetFolder, {
                        scale: 1,
                        boxShadow: 'none',
                        backgroundColor: 'transparent', // Reset to css default
                        clearProps: 'backgroundColor,boxShadow', // cleaner reset
                        duration: 0.2
                    });
                }
            }
        }

        // snap to drop zone (return to list)
        function handleDropZoneSnap(doc) {
            if (state.isHoveringParent) {
                // Return main file
                returnFileToList(doc);

                // Reset folder visual immediately
                const category = doc.dataset.category;
                const folder = document.querySelector(`.folder-stack[data-category="${category}"]`);
                if (folder) {
                    gsap.to(folder, {
                        scale: 1,
                        clearProps: 'all',
                        duration: 0.3
                    });
                }

                state.isHoveringParent = false;
                return true; // Dropped on parent
            }
            return false;
        }

        // return file to list and remove from desk
        function returnFileToList(doc) {
            const category = doc.dataset.category;
            const folder = document.querySelector(`.folder-stack[data-category="${category}"]`);
            const fileList = folder.querySelector('.file-list');

            // gather spilled images first
            gatherImagesToFolder(doc);

            // create list item
            const listItem = document.createElement('div');
            listItem.className = 'file-list-item';
            listItem.dataset.index = doc.dataset.index;
            listItem.dataset.category = doc.dataset.category;
            listItem.dataset.url = doc.dataset.url;
            listItem.dataset.images = doc.dataset.images;
            listItem.dataset.title = doc.querySelector('.doc-title').textContent;
            listItem.dataset.year = doc.querySelector('.doc-year').textContent;

            listItem.innerHTML = `
                <div class="file-item-title">${listItem.dataset.title}</div>
                <div class="file-item-year">${listItem.dataset.year}</div>
            `;

            // make draggable
            listItem.addEventListener('mousedown', (e) => {
                createDocumentFromListItem(listItem, e);
            });

            // animate document to list position then remove
            const listRect = fileList.getBoundingClientRect();
            const containerRect = document.getElementById('desk-container').getBoundingClientRect();
            const targetX = listRect.left - containerRect.left;
            const targetY = listRect.bottom - containerRect.top;

            gsap.to(doc, {
                x: targetX,
                y: targetY,
                scale: 0.5,
                opacity: 0,
                duration: 0.4,
                ease: 'power3.in',
                onComplete: () => {
                    doc.remove();
                    fileList.appendChild(listItem);
                    updateFileCounts();

                    // expand folder to show file was added
                    folder.classList.add('expanded');
                }
            });
        }

        // spill images out from document (toggle behavior)
        function spillImages(doc) {
            const folderIndex = doc.dataset.index;

            // if already spilled, gather back instead
            if (state.spilledFolders.has(folderIndex)) {
                gatherImagesToFolder(doc);
                return;
            }

            // return all other spilled contents first
            const allDocs = document.querySelectorAll('.document');
            allDocs.forEach(otherDoc => {
                if (otherDoc !== doc && state.spilledFolders.has(otherDoc.dataset.index)) {
                    gatherImagesToFolder(otherDoc);
                }
            });

            const images = JSON.parse(doc.dataset.images);
            const docRect = doc.getBoundingClientRect();
            const containerRect = document.getElementById('desk-container').getBoundingClientRect();
            const container = document.getElementById('documents-area');

            // track spilled images for this folder
            state.spilledImages[folderIndex] = [];

            images.forEach((imgUrl, i) => {
                const img = document.createElement('div');
                img.className = 'spilled-image';
                img.style.backgroundImage = `url(${imgUrl})`;
                img.style.backgroundSize = 'cover';
                img.style.backgroundPosition = 'center';
                img.dataset.parent = folderIndex;

                // start position (at document center)
                const startX = docRect.left - containerRect.left + (docRect.width - 180) / 2;
                const startY = docRect.top - containerRect.top + (docRect.height - 140) / 2;

                // random spill direction
                const angle = (Math.random() * 360) * (Math.PI / 180);
                const distance = 100 + Math.random() * 150;
                const endX = startX + Math.cos(angle) * distance;
                const endY = startY + Math.sin(angle) * distance;
                const randomRot = (Math.random() - 0.5) * 30;

                // set initial position
                gsap.set(img, {
                    x: startX,
                    y: startY,
                    rotation: 0,
                    scale: 0.3,
                    opacity: 0,
                    zIndex: 50 + i
                });

                container.appendChild(img);

                // track this image
                state.spilledImages[folderIndex].push(img);

                // animate spill out
                gsap.to(img, {
                    x: endX,
                    y: endY,
                    rotation: randomRot,
                    scale: 1,
                    opacity: 1,
                    duration: 0.2, // much faster
                    delay: i * 0.02, // very fast stagger
                    ease: 'back.out(1.7)',
                    onComplete: () => {
                        makeImageDraggable(img);
                    }
                });
            });

            // mark as spilled
            state.spilledFolders.add(folderIndex);

            // hide parent document temporarily
            gsap.to(doc, {
                opacity: 0.3,
                scale: 0.95,
                duration: 0.3
            });
        }

        // make spilled image draggable
        function makeImageDraggable(img) {
            Draggable.create(img, {
                type: 'x,y',
                bounds: '#desk-container',
                inertia: state.isMobile ? false : true,
                edgeResistance: 0.8,

                onPress: function () {
                    state.currentZIndex++;
                    gsap.to(this.target, {
                        zIndex: state.currentZIndex,
                        scale: 1.05,
                        duration: 0.2
                    });
                },

                onDragEnd: function () {
                    gsap.to(this.target, {
                        scale: 1,
                        duration: 0.3
                    });
                }
            });
        }

        // double-click to open original url
        function openDocument(doc) {
            const url = doc.dataset.url;
            window.open(url, '_blank');
        }

        // gather spilled images back to folder
        function gatherImagesToFolder(doc) {
            const folderIndex = doc.dataset.index;
            const spilledImgs = state.spilledImages[folderIndex];

            if (!spilledImgs || spilledImgs.length === 0) return;

            const docRect = doc.getBoundingClientRect();
            const containerRect = document.getElementById('desk-container').getBoundingClientRect();
            const targetX = docRect.left - containerRect.left + (docRect.width - 180) / 2;
            const targetY = docRect.top - containerRect.top + (docRect.height - 140) / 2;

            spilledImgs.forEach((img, i) => {
                gsap.to(img, {
                    x: targetX,
                    y: targetY,
                    rotation: 0,
                    scale: 0.3,
                    opacity: 0,
                    duration: 0.2, // much faster
                    delay: i * 0.01, // very fast stagger
                    ease: 'power3.in',
                    onComplete: () => {
                        img.remove();
                    }
                });
            });

            // restore folder appearance
            gsap.to(doc, {
                opacity: 1,
                scale: 1,
                duration: 0.3
            });

            // clear tracking
            state.spilledImages[folderIndex] = [];
            state.spilledFolders.delete(folderIndex);
        }

        // cleanup all: return images + files to category folders
        function cleanupAllImages() {
            const docs = document.querySelectorAll('.document');

            docs.forEach(doc => {
                // gather spilled images back
                gatherImagesToFolder(doc);

                // move file back to category folder
                const category = doc.dataset.category;
                const folder = document.querySelector(`.folder-stack[data-category="${category}"]`);
                const folderRect = folder.getBoundingClientRect();
                const containerRect = document.getElementById('desk-container').getBoundingClientRect();

                const targetX = folderRect.left - containerRect.left + (folderRect.width - 280) / 2;
                const targetY = folderRect.top - containerRect.top + (folderRect.height - 200) / 2;

                gsap.to(doc, {
                    x: targetX,
                    y: targetY,
                    rotation: 0,
                    duration: 0.3,
                    ease: 'power3.out'
                });
            });
        }

        // idle animation (subtle paper movement)
        function startIdleAnimation() {
            const docs = document.querySelectorAll('.document');

            docs.forEach((doc, i) => {
                gsap.to(doc, {
                    y: '+=3',
                    rotation: '+=0.5',
                    duration: 3 + Math.random() * 2,
                    repeat: -1,
                    yoyo: true,
                    ease: 'sine.inOut',
                    delay: i * 0.2
                });
            });
        }

        // keyboard shortcuts
        function addKeyboardShortcuts() {
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    window.location.href = '/';
                }

                // category filter shortcuts
                if (e.key === '1') filterByCategory('saas');
                if (e.key === '2') filterByCategory('ecommerce');
                if (e.key === '3') filterByCategory('design');
                if (e.key === '0') showAllDocuments();
            });
        }

        // category filtering
        function filterByCategory(category) {
            const docs = document.querySelectorAll('.document');

            docs.forEach(doc => {
                if (doc.dataset.category === category) {
                    gsap.to(doc, { opacity: 1, scale: 1, duration: 0.3 });
                } else {
                    gsap.to(doc, { opacity: 0.2, scale: 0.9, duration: 0.3 });
                }
            });
        }

        function showAllDocuments() {
            const docs = document.querySelectorAll('.document');
            gsap.to(docs, { opacity: 1, scale: 1, duration: 0.3, stagger: 0.05 });
        }

        // init on load
        window.addEventListener('load', init);
    </script>
</body>

</html>