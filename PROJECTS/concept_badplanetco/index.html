<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BADPLNTCO | Creative Design & Dev</title>
    <link id="favicon" rel="icon" href="data:,">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        /* PREMIUM RESET */
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'UnifrakturMaguntia', cursive;
            animation: lsd-trip 5s infinite linear;
        }

        @keyframes lsd-trip {
            0% {
                filter: hue-rotate(0deg);
            }

            100% {
                filter: hue-rotate(360deg);
            }
        }

        canvas {
            display: block;
            outline: none;
        }

        /* LANDING PAGE UI */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Click through to 3D */
            display: flex;
            align-items: center;
            z-index: 5;
            padding-left: 5%;
        }

        .content-box {
            pointer-events: auto;
            max-width: 600px;
        }

        h1 {
            font-size: 13rem;
            /* WAY OVERSIZED */
            font-weight: 900;
            margin: 0;
            line-height: 0.75;
            color: #ffffff;
            text-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            letter-spacing: -5px;
            /* Tight tracking */
            text-transform: uppercase;
        }

        h2 {
            font-size: 1.4rem;
            font-weight: 500;
            margin: 25px 0 40px 5px;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            line-height: 1.4;
        }

        .btn-group {
            display: flex;
            gap: 20px;
            margin-left: 5px;
        }

        /* BUTTON STYLES WITH MOUSE FX */
        .btn {
            position: relative;
            overflow: hidden;
            padding: 18px 45px;
            font-family: 'Eurostile Extd', 'Eurostile', 'UnifrakturMaguntia', cursive;
            font-size: 14px;
            font-weight: 800;
            border-radius: 50px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
            --x: 50%;
            --y: 50%;
        }

        /* The glow effect container */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            background: radial-gradient(circle at var(--x) var(--y), rgba(255, 255, 255, 0.8) 0%, transparent 60%);
        }

        .btn:hover::before {
            opacity: 1;
        }

        /* Primary */
        .btn-primary {
            background: rgba(255, 255, 255, 0.85);
            color: #000;
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(4px);
        }

        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
        }

        /* Secondary */
        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        /* SIDE PANEL */
        #side-panel {
            position: absolute;
            top: 50%;
            right: 5%;
            transform: translateY(-50%) scale(0.95);
            width: 320px;
            /* Added subtle black tint to increase contrast */
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 24px;
            padding: 30px;
            z-index: 20;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        #side-panel.active {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(-50%) scale(1);
        }

        #side-panel h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            opacity: 0.6;
        }

        .link-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .link-list li {
            margin-bottom: 1px;
            position: relative;
            /* Needed for hover tab */
        }

        /* Tab Glow Effect */
        .link-list li::before {
            content: '';
            position: absolute;
            top: 0;
            left: -30px;
            width: calc(100% + 60px);
            /* 30px padding on both sides */
            height: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0;
            /* REMOVED CURVE */
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 0;
        }

        .link-list li:hover::before {
            opacity: 1;
        }

        .link-list a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            font-weight: 600;
            display: block;
            transition: opacity 0.2s, transform 0.2s;
            position: relative;
            padding: 10px 0;
            /* Vertical padding on links */
            z-index: 1;
            /* Keep text above the ::before glow */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .link-list a:hover {
            opacity: 1.0;
        }

        .link-list a {
            opacity: 0.9;
        }

        .link-list a span {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.7;
            /* Increased readability for subtitle */
            font-weight: 400;
            letter-spacing: 1px;
        }


        /* INSTRUCTIONS / DEBUG FOOTERS */
        #instructions,
        #copyright {
            position: absolute;
            bottom: 30px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
            z-index: 5;
        }

        #instructions {
            left: 5%;
        }

        #copyright {
            right: 5%;
        }

        /* TOOLTIP */
        #tooltip {
            position: absolute;
            pointer-events: none;
            width: 240px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: scale(0.9) translateY(10px);
            transform-origin: bottom center;
            transition: opacity 0.2s ease, transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        #tooltip.visible {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        #tooltip h3 {
            margin: 0 0 5px 0;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #tooltip h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            color: #000;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        #tooltip .color-strip {
            height: 4px;
            width: 30px;
            border-radius: 2px;
            margin-bottom: 10px;
            background: #000;
        }

        /* GUI Tweak */
        .dg.ac {
            z-index: 1000 !important;
            display: none;
        }

        .dg .close-button {
            text-align: center !important;
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 768px) {
            h1 {
                font-size: 25vw;
                /* MASSIVE MOBILE TEXT */
                line-height: 0.8;
                text-align: center;
                word-break: break-word;
                margin-bottom: 20px;
                letter-spacing: -2px;
                width: 100%;
                /* Edge to edge */
                padding: 0;
            }

            h2 {
                font-size: 1.8rem;
                font-weight: 700;
                text-align: center;
                margin: 0 0 30px 0;
                padding: 0;
                /* Remove padding for edge-to-edge */
                opacity: 0.9;
                text-transform: uppercase;
                letter-spacing: 1px;
                width: 100%;
            }

            .content-box {
                padding-left: 0;
                width: 100%;
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                pointer-events: none;
                padding: 0 10px;
                /* Tiny safety padding */
                box-sizing: border-box;
            }

            .content-box>* {
                pointer-events: auto;
            }

            #ui-layer {
                padding-left: 0;
                align-items: center;
                justify-content: center;
            }

            /* Mobile Project Panel - EDGE TO EDGE POPUP */
            #side-panel {
                top: auto;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
                max-width: 100%;
                /* Full width */
                height: auto;
                max-height: 85vh;
                transform: translateY(100%);
                /* Slide up from bottom */
                border-radius: 30px 30px 0 0;
                /* Curved top only */
                border: none;
                border-top: 1px solid rgba(255, 255, 255, 0.2);
                padding: 30px 20px;
                background: rgba(10, 10, 10, 0.98);
                backdrop-filter: blur(40px);
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
                align-items: center;
                z-index: 100;
                opacity: 1;
                pointer-events: auto;
                transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.8);
                box-sizing: border-box;
            }

            #side-panel.active {
                opacity: 1;
                transform: translateY(0);
            }

            #side-panel h3 {
                font-size: 18px;
                font-weight: 900;
                margin-bottom: 20px;
                letter-spacing: 4px;
                text-align: center;
                color: #fff;
            }

            /* 2-COLUMN GRID FOR LINKS */
            .link-list {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
                /* 2 Column */
                gap: 10px;
                margin-bottom: 20px;
            }

            .link-list li {
                margin-bottom: 0;
                width: 100%;
            }

            .link-list a {
                font-size: 16px;
                /* Slightly smaller for grid */
                font-weight: 700;
                justify-content: center;
                padding: 20px 10px;
                background: rgba(255, 255, 255, 0.05);
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.05);
                width: 100%;
                height: 100%;
                flex-direction: column;
                gap: 5px;
                box-sizing: border-box;
                text-align: center;
            }

            .link-list a span {
                display: block;
                font-size: 10px;
                opacity: 0.6;
                font-weight: 400;
                letter-spacing: 1px;
            }

            /* Close Button for Mobile Menu */
            .mobile-close-btn {
                display: block !important;
                margin-top: 10px;
                background: #fff;
                color: #000;
                border: none;
                padding: 20px 0;
                width: 100%;
                border-radius: 50px;
                font-weight: 900;
                text-transform: uppercase;
                letter-spacing: 2px;
                font-size: 14px;
                cursor: pointer;
            }

            /* Mobile Tooltip - FULL WIDTH BOTTOM EDGE-TO-EDGE */
            #tooltip {
                position: fixed !important;
                top: auto !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                width: 100% !important;
                background: #fff;
                color: #000;
                padding: 30px 20px 40px 20px;
                /* Extra bottom pad for safety */
                transform: translateY(100%);
                opacity: 0;
                pointer-events: auto;
                box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
                border-radius: 30px 30px 0 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                z-index: 200;
                box-sizing: border-box;
            }

            #tooltip.visible {
                transform: translateY(0);
                opacity: 1;
            }

            /* Big & Side-by-Side Buttons */
            .btn-group {
                flex-direction: row;
                /* Side by side */
                gap: 10px;
                width: 100%;
                max-width: 100%;
                /* Edge to edge parent */
                padding: 0 15px;
                /* Small pad from screen edge */
                box-sizing: border-box;
                margin: 0;
            }

            .btn {
                width: 100%;
                /* Shared width */
                flex: 1;
                text-align: center;
                padding: 20px 0;
                font-size: 15px;
                font-weight: 900;
                border-radius: 16px;
                /* Slightly less round for rugged feel */
            }
        }

        .mobile-close-btn {
            display: none;
        }

        /* Hidden on Desktop */
    </style>
</head>

<body>

    <!-- DYNAMIC PROJECTS PANEL -->
    <div id="side-panel">
        <h3>Projects</h3>
        <ul class="link-list" id="project-list"></ul>
        <button class="mobile-close-btn" id="btn-close-projects">Close</button>
    </div>

    <div id="ui-layer">
        <div class="content-box">
            <h1>BAD<br>PLNT<br>CO</h1>
            <h2>Creative Design & <br>Ecommerce Development</h2>
            <div class="btn-group">
                <button class="btn btn-primary" id="btn-projects">View Projects</button>
                <button class="btn btn-secondary" id="btn-contact">Contact</button>
            </div>
        </div>
    </div>

    <div id="instructions">Click Orbs to Spin &bull; [1-9] Camera Spots &bull; [~] Controls</div>
    <div id="copyright">
        BADPLNTCO 2026 <br>
        <a href="https://sandbox.zakknowlton.com"
            style="color:inherit; text-decoration:none; opacity:0.7;">sandbox.zakknowlton.com</a>
    </div>

    <div id="tooltip">

        <div class="color-strip" id="tp-color"></div>
        <h3 id="tp-cat">Project</h3>
        <h2 id="tp-title">Title</h2>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>

    <script>
        // --- DYNAMIC FAVICON ---
        (function () {
            const link = document.getElementById('favicon');
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = 64; canvas.height = 64;
                const ctx = canvas.getContext('2d');
                ctx.beginPath();
                ctx.arc(32, 32, 32, 0, 2 * Math.PI);
                ctx.closePath();
                ctx.clip();
                ctx.drawImage(img, 0, 0, 64, 64);
                link.href = canvas.toDataURL();
            };
            img.src = './eyeball-favi.jpg';
        })();

        // --- BUTTON FX ---
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('mousemove', (e) => {
                const rect = btn.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                btn.style.setProperty('--x', x + 'px');
                btn.style.setProperty('--y', y + 'px');
            });
        });

        // --- DATA ---
        const PLANET_DATA = [
            { r: 1.5, color: 0xff3333, orbitR: 35, speed: 0.5, y: 6, name: "ENTRY 00", cat: "SYS" },
            { r: 1.2, color: 0x3388ff, orbitR: 42, speed: -0.3, y: -5, name: "ENTRY 01", cat: "DAT" },
            { r: 0.9, color: 0xffaa00, orbitR: 30, speed: 0.7, y: 14, name: "ENTRY 02", cat: "NET" },
            { r: 2.0, color: 0x9933ff, orbitR: 48, speed: 0.2, y: 0, name: "ENTRY 03", cat: "LOG" }
        ];

        const listEl = document.getElementById('project-list');
        PLANET_DATA.forEach(p => {
            const li = document.createElement('li');
            li.innerHTML = `<a href="#">${p.name} <span>${p.cat}</span></a>`;
            listEl.appendChild(li);
        });

        const panel = document.getElementById('side-panel');
        document.getElementById('btn-projects').addEventListener('click', () => { loadKeyframe(2); panel.classList.add('active'); });
        document.getElementById('btn-contact').addEventListener('click', () => { loadKeyframe(1); panel.classList.remove('active'); }); // Keep existing Contact close logic
        document.getElementById('btn-close-projects').addEventListener('click', () => { loadKeyframe(1); panel.classList.remove('active'); });


        // --------------------------------------------------------
        // [CONFIGURATION BLOCK] - COPY THIS SECTION TO SAVE
        // --------------------------------------------------------
        const PARAMS = {
            sensitivity: 1.2, friction: 0.97, momentumEase: 0.1, snappiness: 0.85,
            grassAttack: 0.05, grassDecay: 0.94, bendPower: 4.0, maxBend: 3.0,
            windSpeed: 1.2, keySpeed: 0.1,

            ballScale: 3.0, grassLength: 1.0, grassWidth: 1.0, skyTint: 0.3,

            transitionDuration: 1000, easeIntensity: 1.0, // Default 1.0 for smooth, controlled move

            // Current Camera State (Loaded from Keyframe 1)
            camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0,
            activeSlot: 1
        };

        const VISUALS = { baseColor: 0x5C4033, radius: 10, geoDetail: 5, grassCount: 200000, grassBaseSize: 0.3 };

        const keyframes = {
            1: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            2: { camX: -100, camY: -100, camZ: 10, aimX: -33, aimY: 29, aimZ: 0 },
            3: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            4: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            5: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            6: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            7: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            8: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 },
            9: { camX: -24, camY: -44, camZ: 65, aimX: -33, aimY: 29, aimZ: 0 }
        };
        // --------------------------------------------------------


        // --- EXPORT FUNCTION ---
        function exportAllSettings() {
            // Update PARAMS with current cam state before export
            PARAMS.camX = parseFloat(camera.position.x.toFixed(2));
            PARAMS.camY = parseFloat(camera.position.y.toFixed(2));
            PARAMS.camZ = parseFloat(camera.position.z.toFixed(2));

            let code = `// --- PASTE THIS OVER THE CONFIGURATION BLOCK ---\n\n`;

            code += `const PARAMS = ${JSON.stringify(PARAMS, null, 4)};\n\n`;
            code += `const VISUALS = ${JSON.stringify(VISUALS, null, 4)};\n\n`;
            code += `const keyframes = ${JSON.stringify(keyframes, null, 4)};\n\n`;

            console.log("%cðŸ“‹ SETTINGS EXPORT:", "color: #00ff00; font-weight: bold; font-size: 14px;");
            console.log(code);
            alert("All Settings exported to Console (F12). Copy/Paste to save.");
        }

        // --- TWEENING ENGINE ---
        let cameraTween = null;

        function saveKeyframe() {
            const s = PARAMS.activeSlot;
            keyframes[s] = {
                camX: parseFloat(PARAMS.camX.toFixed(1)), camY: parseFloat(PARAMS.camY.toFixed(1)), camZ: parseFloat(PARAMS.camZ.toFixed(1)),
                aimX: parseFloat(PARAMS.aimX.toFixed(1)), aimY: parseFloat(PARAMS.aimY.toFixed(1)), aimZ: parseFloat(PARAMS.aimZ.toFixed(1))
            };
            console.log(`Saved View to Slot ${s}`);
        }

        function loadKeyframe(slot) {
            const target = keyframes[slot];
            if (!target) return;
            PARAMS.activeSlot = slot;
            cameraTween = {
                start: { camX: PARAMS.camX, camY: PARAMS.camY, camZ: PARAMS.camZ, aimX: PARAMS.aimX, aimY: PARAMS.aimY, aimZ: PARAMS.aimZ },
                end: target, startTime: performance.now(), duration: PARAMS.transitionDuration
            };
        }

        // EaseOutExpo (No Overshoot)
        function easeOutExpo(x) {
            return x === 1 ? 1 : 1 - Math.pow(2, -10 * x);
        }

        // Custom Ease Logic (Smooth, no reel-back)
        function customEase(t) {
            // We are using easeOutExpo regardless of setting for smoothness, unless it's intentionally non-1.0
            return easeOutExpo(t);
        }

        // --- RENDERER ---
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputEncoding = THREE.sRGBEncoding;
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        // scene.fog = new THREE.Fog(0x000000, 20, 100); // Optional fog for depth
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

        // --- SCENE OBJECTS ---
        // Skybox Removed for Black Studio Look
        let skyboxMesh = null;
        function updateSkyTint(val) { /* No-op */ }

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1.3);
        dirLight.position.set(10, 30, 20);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.set(2048, 2048);
        dirLight.shadow.radius = 4;
        scene.add(dirLight);

        const orbGroup = new THREE.Group();
        orbGroup.scale.setScalar(PARAMS.ballScale);
        scene.add(orbGroup);

        const baseGeo = new THREE.IcosahedronGeometry(VISUALS.radius, VISUALS.geoDetail);
        const dirtMat = new THREE.MeshStandardMaterial({ color: VISUALS.baseColor, roughness: 0.9 });
        const baseMesh = new THREE.Mesh(baseGeo, dirtMat);
        baseMesh.receiveShadow = true;
        orbGroup.add(baseMesh);

        let instancedGrass;
        const grassGeo = new THREE.PlaneGeometry(0.05, 0.4);
        grassGeo.translate(0, 0.2, 0);
        const grassMaterial = new THREE.ShaderMaterial({
            vertexShader: `
                varying vec2 vUv; uniform float uTime; uniform vec3 uRotVel; 
                uniform float uBendPower; uniform float uMaxBend; 
                uniform float uLength; uniform float uWidth;
                float rand(vec2 co){ return fract(sin(dot(co, vec2(12.9898, 78.233))) * 43758.5453); }
                void main() {
                    vUv = uv; vec3 pos = position;
                    pos.y *= uLength; pos.x *= uWidth;
                    float id = instanceMatrix[3][0]; 
                    float rnd = rand(vec2(id, 1.0));
                    pos.y *= (0.7 + rnd * 0.6); 
                    vec4 worldPos = modelMatrix * instanceMatrix * vec4(pos, 1.0);
                    vec3 moveDir = cross(uRotVel, worldPos.xyz);
                    vec3 bend = -moveDir * uBendPower; 
                    if (length(bend) > uMaxBend) bend = normalize(bend) * uMaxBend;
                    float noise = sin(2.0 * worldPos.x + uTime * 2.0) * cos(2.0 * worldPos.z + uTime * 1.5);
                    vec3 wind = vec3(noise * 0.05, 0.0, noise * 0.05);
                    float flexibility = vUv.y * vUv.y; 
                    worldPos.xyz += (bend + wind) * flexibility;
                    gl_Position = projectionMatrix * viewMatrix * worldPos;
                }
            `,
            fragmentShader: `varying vec2 vUv; uniform vec3 uColorBottom; uniform vec3 uColorTop; void main() { gl_FragColor = vec4(mix(uColorBottom, uColorTop, vUv.y), 1.0); }`,
            uniforms: {
                uTime: { value: 0 }, uRotVel: { value: new THREE.Vector3(0, 0, 0) },
                uBendPower: { value: PARAMS.bendPower }, uMaxBend: { value: PARAMS.maxBend },
                uLength: { value: PARAMS.grassLength }, uWidth: { value: PARAMS.grassWidth },
                uColorBottom: { value: new THREE.Color(0x115500) }, uColorTop: { value: new THREE.Color(0x44cc00) }
            },
            side: THREE.DoubleSide
        });

        function initGrass() {
            if (instancedGrass) { orbGroup.remove(instancedGrass); instancedGrass.dispose(); }
            instancedGrass = new THREE.InstancedMesh(grassGeo, grassMaterial, VISUALS.grassCount);
            const dummy = new THREE.Object3D();
            const _pos = new THREE.Vector3();
            const _quat = new THREE.Quaternion();
            const upVec = new THREE.Vector3(0, 1, 0);
            for (let i = 0; i < VISUALS.grassCount; i++) {
                const u = Math.random(), v = Math.random();
                const theta = 2 * Math.PI * u, phi = Math.acos(2 * v - 1);
                _pos.setFromSphericalCoords(VISUALS.radius, phi, theta);
                _quat.setFromUnitVectors(upVec, _pos.clone().normalize());
                _quat.multiply(new THREE.Quaternion().setFromAxisAngle(upVec, Math.random() * Math.PI * 2));
                dummy.position.copy(_pos); dummy.rotation.setFromQuaternion(_quat); dummy.scale.setScalar(1.0); dummy.updateMatrix();
                instancedGrass.setMatrixAt(i, dummy.matrix);
            }
            instancedGrass.instanceMatrix.needsUpdate = true;
            instancedGrass.receiveShadow = true;
            orbGroup.add(instancedGrass);
        }
        initGrass();

        const interactables = [];
        PLANET_DATA.forEach((data) => {
            const geo = new THREE.SphereGeometry(data.r, 32, 32);
            const mat = new THREE.MeshStandardMaterial({ color: data.color, roughness: 0.2, metalness: 0.1, emissive: data.color, emissiveIntensity: 0.3 });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.userData = { angle: Math.random() * Math.PI * 2, orbitR: data.orbitR, speed: data.speed, y: data.y, color: new THREE.Color(data.color), type: 'planet', name: data.name, cat: data.cat };
            mesh.castShadow = true; mesh.receiveShadow = true;
            scene.add(mesh); interactables.push(mesh);
        });

        function createUFO() {
            const g = new THREE.Group();
            const matS = new THREE.MeshStandardMaterial({ color: 0xeeeeee, metalness: 0.9, roughness: 0.1 });
            const matG = new THREE.MeshStandardMaterial({ color: 0x00ffff, transparent: true, opacity: 0.5 });
            g.add(new THREE.Mesh(new THREE.CylinderGeometry(0.5, 1.5, 0.3, 16), matS));
            const d = new THREE.Mesh(new THREE.SphereGeometry(0.6, 16, 16, 0, Math.PI * 2, 0, Math.PI * 0.5), matG); d.position.y = 0.1; g.add(d);
            const l = new THREE.PointLight(0x00ffff, 1, 8); l.position.y = -0.5; g.add(l);
            g.userData = { angle: 0, orbitR: 25, speed: 0.8, y: 6, color: new THREE.Color(0x00ffff), type: 'ufo', name: "Contact", cat: "UFO" };
            scene.add(g); interactables.push(g); g.traverse(c => { if (c.isMesh) c.userData = g.userData; });
        }
        createUFO();

        // --- LOOP ---
        const clock = new THREE.Clock();
        const gui = new dat.GUI({ closed: true });
        setTimeout(() => { const b = document.querySelector('.dg .close-button'); if (b) b.innerHTML = 'Controls'; }, 1000);
        const camFolder = gui.addFolder('Camera & Layout');
        camFolder.add(PARAMS, 'ballScale', 0.5, 5.0).name('Ball Size').onChange(v => orbGroup.scale.setScalar(v));
        camFolder.add(PARAMS, 'camX', -100, 100).name('Cam X').listen();
        camFolder.add(PARAMS, 'camY', -100, 100).name('Cam Y').listen();
        camFolder.add(PARAMS, 'camZ', 10, 200).name('Cam Zoom').listen();
        camFolder.add(PARAMS, 'aimX', -100, 100).name('Aim X (Pan)').listen();
        camFolder.add(PARAMS, 'aimY', -100, 100).name('Aim Y (Tilt)').listen();
        camFolder.add(PARAMS, 'skyTint', 0.0, 1.0).name('Sky Tint').onChange(updateSkyTint);
        const transFolder = gui.addFolder('Transitions');
        transFolder.add(PARAMS, 'transitionDuration', 100, 5000).name('Duration (ms)');
        transFolder.add(PARAMS, 'easeIntensity', 0.0, 3.0).name('Ease Overshoot');
        const keyFolder = gui.addFolder('Keyframes');
        keyFolder.add(PARAMS, 'activeSlot', [1, 2, 3, 4, 5, 6, 7, 8, 9]).name('Slot').listen();
        keyFolder.add({ save: saveKeyframe }, 'save').name('Save View');
        keyFolder.add({ export: exportAllSettings }, 'export').name('Export ALL Settings');
        const visFolder = gui.addFolder('Visuals');
        visFolder.add(VISUALS, 'grassCount', 10000, 300000).step(1000).onFinishChange(initGrass);
        const physFolder = gui.addFolder('Physics');
        physFolder.add(PARAMS, 'sensitivity', 0.1, 3.0);
        physFolder.add(PARAMS, 'keySpeed', 0.001, 0.1);

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const elTooltip = document.getElementById('tooltip');
        const elTitle = document.getElementById('tp-title'), elCat = document.getElementById('tp-cat'), elColor = document.getElementById('tp-color');
        let hoveredObj = null;
        const keys = {};
        let targetGrassColorTop = new THREE.Color(0x44cc00); // Default to green
        let targetGrassColorBottom = new THREE.Color(0x115500); // Default to dark green
        let targetDirtColor = new THREE.Color(VISUALS.baseColor); // Default to brown base

        window.addEventListener('keydown', (e) => {
            if (e.key === '`' || e.key === '~') { const g = document.querySelector('.dg.ac'); if (g) g.style.display = g.style.display === 'none' ? 'block' : 'none'; }
            if (e.key >= '1' && e.key <= '9') loadKeyframe(parseInt(e.key));
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key)) keys[e.key] = true;
        });
        window.addEventListener('keyup', (e) => keys[e.key] = false);
        window.addEventListener('mousemove', (e) => { mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1; });
        window.addEventListener('click', () => {
            if (hoveredObj) {
                targetGrassColorTop.copy(hoveredObj.userData.color);
                targetDirtColor.copy(hoveredObj.userData.color);
                targetGrassColorBottom.copy(hoveredObj.userData.color).multiplyScalar(0.2);

                // --- NEW CLICK IMPULSE LOGIC ---
                // "Rapidly shift toward cursor" -> spin towards the clicked planet
                // We use mouse position to determine direction of spin
                const force = 0.15 * PARAMS.sensitivity;
                orbVel.x += -mouse.y * force; // Rotate X based on Y pos
                orbVel.y += mouse.x * force;  // Rotate Y based on X pos
            }
        });

        let orbVel = { x: 0, y: 0 }, grassVel = { x: 0, y: 0 };
        // Cleaned up unused drag variables
        document.addEventListener('mousemove', (e) => {
            // kept for future mouse pos needs if any, currently simple cursor tracking is in window listener
        });

        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            const time = clock.getElapsedTime();

            // --- COLOR INTERPOLATION (LERP) ---
            const colorLerpFactor = 0.2;
            grassMaterial.uniforms.uColorTop.value.lerp(targetGrassColorTop, colorLerpFactor);
            grassMaterial.uniforms.uColorBottom.value.lerp(targetGrassColorBottom, colorLerpFactor);
            dirtMat.color.lerp(targetDirtColor, colorLerpFactor);


            if (cameraTween) {
                let t = (performance.now() - cameraTween.startTime) / cameraTween.duration;
                if (t >= 1) { t = 1; cameraTween = null; }
                const eT = customEase(t);
                PARAMS.camX = THREE.MathUtils.lerp(cameraTween.start.camX, cameraTween.end.camX, eT);
                PARAMS.camY = THREE.MathUtils.lerp(cameraTween.start.camY, cameraTween.end.camY, eT);
                PARAMS.camZ = THREE.MathUtils.lerp(cameraTween.start.camZ, cameraTween.end.camZ, eT);
                PARAMS.aimX = THREE.MathUtils.lerp(cameraTween.start.aimX, cameraTween.end.aimX, eT);
                PARAMS.aimY = THREE.MathUtils.lerp(cameraTween.start.aimY, cameraTween.end.aimY, eT);
                PARAMS.aimZ = THREE.MathUtils.lerp(cameraTween.start.aimZ, cameraTween.end.aimZ, eT);
                for (var i in camFolder.__controllers) camFolder.__controllers[i].updateDisplay();
            }

            camera.position.set(PARAMS.camX, PARAMS.camY, PARAMS.camZ);
            camera.lookAt(PARAMS.aimX, PARAMS.aimY, PARAMS.aimZ);

            let kx = 0, ky = 0;
            if (keys.ArrowUp || keys.w) kx = -PARAMS.keySpeed; if (keys.ArrowDown || keys.s) kx = PARAMS.keySpeed;
            if (keys.ArrowLeft || keys.a) ky = -PARAMS.keySpeed; if (keys.ArrowRight || keys.d) ky = PARAMS.keySpeed;

            if (kx !== 0 || ky !== 0) {
                orbGroup.rotation.x += kx; orbGroup.rotation.y += ky;
                orbVel.x = kx; orbVel.y = ky;
            } else {
                orbVel.x *= PARAMS.friction; orbVel.y *= PARAMS.friction;
                orbGroup.rotation.x += orbVel.x; orbGroup.rotation.y += orbVel.y;
            }

            grassVel.x = THREE.MathUtils.lerp(grassVel.x, orbVel.x, PARAMS.grassAttack);
            grassVel.y = THREE.MathUtils.lerp(grassVel.y, orbVel.y, PARAMS.grassAttack);
            grassVel.x *= PARAMS.grassDecay; grassVel.y *= PARAMS.grassDecay;
            grassMaterial.uniforms.uRotVel.value.set(grassVel.x * 50.0, grassVel.y * 50.0, 0);
            grassMaterial.uniforms.uTime.value = time * PARAMS.windSpeed;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(interactables, true);
            let found = null;
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                found = (obj.parent && obj.parent.userData.type === 'ufo') ? obj.parent : obj;
            }
            hoveredObj = found;
            document.body.style.cursor = hoveredObj ? 'pointer' : 'default';

            if (hoveredObj) {
                elTooltip.classList.add('visible');

                // Only follow mouse if NOT mobile (simple width check)
                if (window.innerWidth > 768) {
                    const vec = new THREE.Vector3(); hoveredObj.getWorldPosition(vec); vec.project(camera);
                    const x = (vec.x * 0.5 + 0.5) * window.innerWidth; const y = (-(vec.y * 0.5) + 0.5) * window.innerHeight;
                    elTooltip.style.left = `${x + 20}px`; elTooltip.style.top = `${y - 60}px`;
                    elTooltip.style.right = 'auto'; elTooltip.style.bottom = 'auto';
                } else {
                    // Reset inline styles so CSS takes over for mobile fixed position
                    elTooltip.style.left = ''; elTooltip.style.top = '';
                    elTooltip.style.right = ''; elTooltip.style.bottom = '';
                }

                const tid = hoveredObj.uuid;
                if (elTooltip.dataset.target !== tid) {
                    elTooltip.dataset.target = tid; elTitle.innerText = hoveredObj.userData.name || "Unknown"; elCat.innerText = hoveredObj.userData.cat || "Project"; elColor.style.backgroundColor = '#' + hoveredObj.userData.color.getHexString();
                }
            } else { elTooltip.classList.remove('visible'); elTooltip.dataset.target = ''; }

            interactables.forEach(obj => {
                const d = obj.userData;
                const ts = (obj === hoveredObj) ? 1.5 : 1.0;
                obj.scale.lerp(new THREE.Vector3(ts, ts, ts), 0.1);
                if (obj !== hoveredObj) { d.angle += d.speed * dt; if (d.type === 'ufo') obj.rotation.y += 2 * dt; }
                else { if (d.type === 'ufo') obj.rotation.y += 10 * dt; }
                obj.position.x = Math.cos(d.angle) * d.orbitR; obj.position.z = Math.sin(d.angle) * d.orbitR; obj.position.y = d.y + Math.sin(time + d.orbitR) * 0.5;
            });

            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight);
        });
        animate();
    </script>
</body>

</html>